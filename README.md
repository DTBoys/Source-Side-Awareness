# 源端感知
云上的数据（本文基于MaxCompute）对源端表结构的变化显得异常敏感，为了防止后续业务的错乱和延迟，我们需要尽快感知到源端的变化，因此该项目解决了源端感知问题
## 背景介绍
大数据云平台如MaxCompute是离线计算平台，其内含表结构在初始化时就已经固定，而源端的ORACLE，MySQL等都是云下实时在线数据库，云上云下无法形成统一的感知交互和事后处理，一旦源端表结构发生变化，而云平台又未及时获知，对后续的应用业务，OGG，流计算等都会造成不小的麻烦，时间越长需要补做的数据就越多，对业务的影响也就越大，甚至需要重新初始化，加大人力成本和时间成本。表结构变化包括：列字段改名，列字段新增，列字段删除，数据类型变化
## 总体设计
通过自动脚本阶段性来对比源端和云平台之间的表结构，有不同之处及时把变化数据采集发送，从而做到及时的源端感知，后续再用ETL工具将捕获的差异化信息，提交至在线层，通过前端应用展示出变化的内容及影响分析，建立良好的报警机制，将表结构变化的影响降到最低。
<img alt="流程图" src="https://img-blog.csdnimg.cn/20181205091754798.png" width="660" />
## 实施过程
1. 由于大多数数据库和云平台客户端都安装在linux系统，故可采用shell脚本来实施。第一次初始化需要把源端表结构按系统进行时间镜像备份，后续就用最新的源端表结构与该备份表结构进行差异化对比，每一次新增表或者重新初始化时需要更新备份
2. 按系统通过表结构对比脚本获取变化的内容并生成两个csv，一份是对比信息，存放对比了多少表，什么系统，有多少表有问题等概览内容，另一份存放的是表结构变化的具体信息
3. 把各个系统运行的两份文件各cat合并成两份总csv文件，并调度datax把这两份csv文件上云到ODPS的对应表，这两张表可以通过RWBH进行主从表关联
## 操作步骤
1. 运行ty_compare_table_column.sh获取变化的内容并生成两个csv，一份是对比信息，存放对比了多少表，什么系统，有多少表有问题等概览内容，另一份存放的是表结构变化的具体表信息
2. 通过ty_run_ydgz_commit.sh把各个系统运行的两份文件各cat合并成两份总csv文件，并调度datax把这两份csv文件上云到ODPS的SC_JS_YY层下的两张表:T_YY_YDGZ_YDBBGDJMX和T_YY_YDGZ_DBXX，这两张表通过rwbh进行主从表关联
3. 两个json文件一个是主表json(T_YY_YDGZ_DBXX_RZ.json)，另一个是从表json(T_YY_YDGZ_YDBBGDJMX_RZ.json)，分别对应主从表数据被ty_run_ydgz_commit.sh调用DataX使用

### 主表信息概览
<img alt="主表图" src="https://img-blog.csdnimg.cn/20181205093132858.png" width="660" />

### 从表信息概览
<img alt="从表图" src="https://img-blog.csdnimg.cn/20181205093303305.png" width="660" />
